# Network Layer

**네트워크 계층(Network Layer)**은 라우팅을 담당하며, 혼잡 제어를 제공한다.



## 라우팅

**라우팅(Routing)**은 패킷이 전달되는 가장 효과적인 경로를 선택하는 과정이다. 라우팅은 정적 라우팅과 동적 라우팅으로 나뉜다.

**정적 라우팅(static routing)**은 관리자가 수동으로 최적의 경로 정보를 라우터별로 저장하여 관리한다. 운용 중인 네트워크 구성이 바뀐다면 대처하기가 어렵고, 네트워크 혼잡도를 반영할 수 없다는 단점이 있다.

**동적 라우팅(dynamicrouting)**은 현재 네트워크 상황에 따라 자동으로 라우터에 저장된 경로 정보를 변경한다. 상황을 고려한 최적의 경로 정보를 선택할 수 있다. 경로 정보를 수집하고 관리하는 작업이 복잡하여 네트워크에 새로운 부하를 가한다는 단점이 있다.

### 라우팅 테이블

라우터는 **라우터 테이블(routing table)**에 저장된 정보를 이용하여 경로를 선택한다. 라우팅 테이블의 엔트리는 목적지 호스트와 다음 홉(hop)을 포함한다. 목적지 호스트에는 패킷의 최종 목적지 호스트의 주소 값을 저장한다. 다음 홉에는 목적지 호스트로 가기 위한 최적의 이웃 라우터를 지정한다. 

### 라우팅 정보의 처리

라우팅 정보를 처리하는 방법에는 소스 라우팅, 분산 라우팅, 중앙 라우팅, 계층 라우팅 등이 있다.

- **소스 라우팅(Source Routing)**은 패킷을 전송하는 호스트가 목적지 호스트까지 전달 경로를 스스로 결정하는 방식이다. 송신 호스트의 라우팅 테이블에서 목적지까지의 경로 정보를 관리해야 하며, 이 경로 정보를 전송 패킷에 기록해야 한다. 중간에 있는 라우터들은 라우팅 테이블을 따로 관리하지 않아도 된다.
- **분산 라우팅(Distributed Routing)**은 중간에 있는 라우터가 효율적인 경로 선택에 참여하는 방식이다. 데이터그램 방식에서 많이 사용한다. 경로 정보는 동적으로 변한다.
- **중앙 라우팅(Centralized Routing)**은 RCC(Routing Control Center)라는 호스트를 사용해 모든 경로 정보를 관리하는 방식이다. 송신 호스트는 RCC로부터 목적지까지의 경로 정보를 미리 얻은 후 소스 라우팅과 동일하게 동작하다.
- **계층 라우팅(Hierarchical Routing)**은 분산 라우팅과 중앙 라우팅을 혼합한 방식으로 전체 네트워크의 구성을 계층 구조로 관리한다.



## 혼잡 제어

네트워크에 존재하는 전송 패킷의 수가 많아지면 네트워크의 성능이 감소한다. 이러한 성능 감소가 급격하게 악화되는 현상을 **혼잡(congestion)**이라고 하며 혼잡을 해결하기 위한 방안을 **혼잡 제어(congestion control)**이라고 한다.

### 혼잡의 원인

혼잡은 기본적으로 네트워크가 처리할 수 있는 패킷보다 많은 패킷이 입력되어 발생한다. 패킷이 분실되는 경우, 혹은 패킷 순서가 바뀌어 패킷을 버리는 경우 송신 호스트는 타임아웃 동작을 통해 패킷을 재전송한다. 결국 네트워크 혼잡도가 계속 증가하는 악순환에 빠지게 된다. 혼잡이 포착되면 타임아웃 시간을 늘려 재전송이 빈번하게 일어나지 않도록 하거나 트래픽이 적은 경로로 패킷을 전송하여 혼잡도를 줄일 수 있다. 한편 패킷이 네트워크에서 생존할 수 있는 시간을 너무 크게 주면 불필요한 부하를 줄 수 있고, 너무 작게 주면 패킷이 강네트워크 질문 혼잡 제어제로 제거되어 재전송이 발생할 수 있다. 따라서 패킷의 생존 시간을 적절히 설정해주어야 한다.

### 혼잡 제거

라우터는 출력 선로의 사용 정도가 한계치를 초과하면 주의 표시를 한다. 패킷이 주의 표시된 출력 선로로 라우팅 되는 경우  송신 호스트에게 `ECN` 패킷을 전송한다. `ECN` 패킷을 인지한 송신 호스트는 `ECN` 패킷이 발생하지 않을 때까지 전송 패킷의 양을 줄인다.



## 패킷 교환 방식

송신자 호스트와 수신자 호스트는 패킷을 전송하기 전 서로 연결을 설정하거나 그러지 않을 수 있다.

**가상 회선 패킷 교환 방식**에서는 송수신자가 패킷을 전달하기 전 서로 논리적으로 연결을 설정한다. 이때 논리적 연결을 가상 회선이라고 하며, 패킷은 가상 회선을 통하여 전송된다. **데이터그램 패킷 교환 방식**에서는 연결을 설정하지 않아 패킷이 독립적으로 전송된다. 이때의 패킷을 데이터그램이라고 한다.

**연결 서비스**는 가상 회선 방식을 사용하여 연결이 설정되는 시점에 전달 경로가 선택된다. 따라서 패킷이 모두 동일한 경로를 통해 전달되어 패킷의 전달 순서가 보장된다. 또한 패킷이 제대로 도착했는지를 확인한다. 

**비연결 서비스**는 데이터그램 방식을 사용하여 매 전송마다 전달 경로를 선택한다. 따라서 패킷이 서로 다른 경로를 통해 전달되어 패킷의 전달 순서가 보장되지 않는다. 또한 패킷이 제대로 도착했는지를 확인하지 않는다. 그래서 연결 서비스보다 데이터의 신뢰성이 떨어진다.



## IP

**IP(Internet Protocol)**는 인터넷 환경에서 네트워크 계층의 데이터 전송 프로토콜로 이용된다. 비연결 서비스를 제공한다. IP에서 사용하는 데이터의 단위를 **패킷(package)**이라고 한다. 패킷은 IP 헤더와 데이터 필드로 나뉜다.

### IP 주소 체계

IP 주소는 32비트의 이진수로 8비트씩 끊어 `.`로 구분한다. IP 주소 체계는 다섯 클래스 A, B, C, D, E로 구분된다. A, B, C는 유니캐스팅에 사용하며 D는 멀티캐스팅에 이용한다. E는 새로운 응용 환경을 위해 잠정적으로 예약되었다.

클래스 A, B, C는 주소를 `network`와 `host` 필드로 구분한다.

- `network`: 네트워크를 구분하는 네트워크 주소이다. NIC(Network Information Center)에서 담당한다.
- `host`: 호스트를 구분하는 호스트 주소이다. 네트워크 주소가 결정되면 네트워크 관리자가 할당한다.

### IP Header

#### DS/ECN

- DS(Differentiated Services): 차등 서비스의 기준이 되는 레이블 값으로 2^6개의 트래픽 클래스를 정의할 수 있다.
- ECN(Explicit Congestion Notification): 송신 호스트가 라우터에게 IP 패킷에 캡슐화된 TCP 프로토콜이 ECN 기능을 지원한다고 알려주기 위해 사용한다.
  - `00`: IP 패킷이 ECN 기능을 사용하지 않음
  - `01(ECT 1)`, `00(ECT 0)`: TCP 프로토콜도 ECN 기능을 지원한다.
  - `11(CE: Congestion Experienced)`: 라우터가 송신 호스트에 혼잡을 통지하기 위해 사용한다.

#### 패킷 분할

IP는 상위 계층에서 내려온 데이터가 크면 분할(fragmentation)하여 전송한다.

- Identification: 송신 호스트는 분할된 패킷들에 동일한 고유 번호를 부여한다. 수신 호스트는 이 필드로 동일한 번호를 가진 패킷들을 병합(reassembly)할 수 있다. 분할된 패킷이 아니라면 필드의 값이 1씩 증가한다.
- DF(Don't Fragment): 수신 호스트가 패킷을 병합하는 기능이 없을 때 설정하여 패킷이 분할되지 않도록 한다. 중간 경유 네트워크는 IP 패킷이 자신이 처리 가능한 것보다 크고 이 필드가 설정되어있으면 패킷을 버린다.
- MF(More Fragment): 분할 패킷은 연속하여 전송되므로, `1`로 지정하면 뒤에 오는 패킷이 분할 패킷임을 알린다. 마지막 분할 패킷은 `0`으로 지정한다/
- Fragment Offset: 분할 전 데이터에서 위치하는 상대 주소 값을 저장한다.

#### 주소

- Source Address: 송신 호스트의 IP 주소
- Destination Address: 수신 호스트의 IP 주소

#### 기타

- Version Number: IP 프로토콜의 버전 번호
- Header Length: IP 프로토콜 헤더의 길이를 32비트 워드 단위로 표시한다.
- Packet Length: IP 헤더를 포함한 패킷의 길이를 표시한다.
- Time to Live: 패킷이 목적지에 도착하지 못해 네트워크에서 떠돌지 않도록 생존 시간을 지정한다. `0`으로 감소하면 패킷은 버려지고 송신 호스트에 ICMP 오류 메시지가 전달된다.
- Transport:  IP에 데이터 전송을 요구한 전송 계층의 프로토콜을 가리킨다. TCP는 6, UDP는 17, CMP는 1이다.
- Header Checksum: 헤더의 오류를 검출한다. 오류가 검출되면 해당 패킷을 버린다.
- Options: 기타 용도로 사용할 정보를 넣는다.
- Padding: 헤더의 크기를 4바이트 단위로 맞추기 위해 사용한다.



## IPv6

현재 사용되고 있는 IPv4는 32비트의 주소 공간을 지원한다. 인터넷의 확장에 따라 여러 문제점이 제기되었다. 차세대 IP인 IPv6은 IPv4와 비교하여 다음 기능을 제공한다. 첫번째, 주소 공간이 128비트로 확장되었다. 두번째, 헤더 구조가 단순화되었다. 세번째, 흐름 제어 기능을 지원한다.

### IPv6 Header

#### DS/ECN 필드

IPv4와 동일

#### Flow Label 필드

IPv4 패킷은 라우터가 동일한 기준을 적용하여 중개하한다. IPv6은 특정 송수신 호스트 사이에서 전송되는 데이터를 하나의 flow으로 정의해 중간 라우터가 IPv6 패킷을 특별한 기준으로 처리할 수 있도록 지원한다.

#### 주소

- Source Address: 송신 호스트의 IP 주소
- Destination Address: 수신 호스트의 IP 주소

#### 기타 필드

- Version Numbe: 6으로 지정된다.
- Payload Length: 헤더를 제외한 패킷의 크기. 바이트 단위.
- Next Header: 기본 헤더 다음에 이어지는 헤더의 유형을 수신 호스트에 알려준다. IPv6의 확장 헤더, TCP/UDP의 헤더일 수 있다.
- Hop Limit: IPv4의 Time To Live와 동일하다. 이론상 시간 개념이 포함되었던 것을 단순화하여 중개되는 횟수로만 처리한다.

#### 확장 헤더

IPv6 헤더 뒤에 하나 이상의 확장 헤더를 추가할 수 있다.

- Hop-by-Hop Options Header
- Routing Header: IPv4의 소스 라우팅과 유사한 기능을 제공한다. 주소 목록에 적힌 순서대로 호스트를 거치도록 한다.
- Fragment Header: IPv4 헤더의 패킷 분할과 관련된 정보(Fragment Offset, Identification, MF 필드)를 포함한다.
- Destination Options Header: 수신 호스트가 확인할 수 있는 옵션 정보 제공
- Authenication Header: 패킷 인증과 관련된 기능 제공
- Encapsulating Security Payload Header: 페이로드를 암호화한다. 목적지 호스트에서 암호화 데이터를 해독할 수 있는 정보를 제공한다.

### Ipv6 주소

IPv6 주소는 128비트의 이진수로 16비트씩 끊어 `:`로 구분한다.
