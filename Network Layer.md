# Network Layer

**네트워크 계층(Network Layer)**은 라우팅을 담당하며, 혼잡 제어를 제공한다.



## 라우팅

**라우팅(Routing)**은 경로 정보를 사용하여 패킷이 전달되는 가장 효과적인 경로를 선택하는 과정이다. 포워딩(forwarding)은 라우터가 입력된 패킷을 올바른 포트로 출력하는 것을 말한다.

라우터 초기화 과정에서 `HELLO 패킷`을 전송해 이웃 라우터의 경로 정보를 얻는다. `ECHO 패킷`을 전송하면 수신 호스트가 즉각 회신하므로, 여러 번 측정한 값의 평균으로 라우터까지의 전송 지연 시간을 유추한다.

### 정적 라우팅과 동적 라우팅

라우팅은 정적 라우팅과 동적 라우팅으로 나눌 수 있다.

**정적 라우팅(static routing)**은 관리자가 수동으로 최적의 경로 정보를 라우터별로 저장하여 관리한다. 운용 중인 네트워크 구성이 바뀐다면 대처하기가 어렵고, 네트워크 혼잡도를 반영할 수 없다는 단점이 있다.

**동적 라우팅(dynamicrouting)**은 현재 네트워크 상황에 따라 자동으로 라우터에 저장된 경로 정보를 변경한다. 상황을 고려한 최적의 경로 정보를 선택할 수 있다. 경로 정보를 수집하고 관리하는 작업이 복잡하여 네트워크에 새로운 부하를 가한다는 단점이 있다.

### 라우팅 테이블

라우터는 네트워크의 모든 호스트가 유지하는 **라우터 테이블(routing table)**에 저장된 정보를 이용하여 경로를 선택한다. 라우팅 테이블의 엔트리는 목적지 호스트와 다음 홉(hop)을 포함한다. 목적지 호스트에는 패킷의 최종 목적지 호스트의 주소 값을 저장한다. 다음 홉에는 목적지 호스트로 가기 위한 최적의 이웃 라우터를 지정한다.

### 라우팅 정보의 처리

라우팅 정보를 처리하는 방법에는 소스 라우팅, 분산 라우팅, 중앙 라우팅, 계층 라우팅 등이 있다.

- **소스 라우팅(Source Routing)**은 패킷을 전송하는 호스트가 목적지 호스트까지 전달 경로를 스스로 결정하는 방식이다. 송신 호스트의 라우팅 테이블에서 목적지까지의 경로 정보를 관리해야 하며, 이 경로 정보를 전송 패킷에 기록해야 한다. 중간에 있는 라우터들은 라우팅 테이블을 따로 관리하지 않아도 된다.
- **분산 라우팅(Distributed Routing)**은 중간에 있는 라우터가 효율적인 경로 선택에 참여하는 방식이다. 데이터그램 방식에서 많이 사용한다. 경로 정보는 동적으로 변한다.
- **중앙 라우팅(Centralized Routing)**은 RCC(Routing Control Center)라는 호스트를 사용해 모든 경로 정보를 관리하는 방식이다. 송신 호스트는 RCC로부터 목적지까지의 경로 정보를 미리 얻은 후 소스 라우팅과 동일하게 동작하다.
- **계층 라우팅(Hierarchical Routing)**은 분산 라우팅과 중앙 라우팅을 혼합한 방식으로 전체 네트워크의 구성을 계층 구조로 관리한다.

### 라우팅 프로토콜

라우팅 프로토콜(routing protocol)은 라우터 간 정보를 교환하는 방식을 규정하는 프로토콜이다. 라우팅 메트릭(routing metric)은 최적의 경로를 결정할 때 기준이 되는 값을 의미한다. 컨버전스 타임(convergence time)은 라우팅 테이블에 네트워크의 변화가 반영되기까지 걸리는 시간이다.

### 내부 라우팅과 외부 라우팅

**AS(Autonomous System)**은 하나의 관리자에 의해 동일한 라우팅 정책으로 운영되는 네트워크이다. **내부 라우팅 프로토콜(IGP;Interior Gateway Protocol)**은 하나의 AS 내에서 사용하는 라우팅 프로토콜이다. 거리 벡터 라우팅 프로토콜과 링크 상태 라우팅 프로토콜을 사용한다. **외부 라우팅 프로토콜(EGP; Enhanced Interior Gateway Protocol)**은 AS(게이트웨이) 간의 라우팅에 사용하는 프로토콜이다. 경로 벡터 라우팅 프로토콜을 사용한다.

### 거리 벡터 라우팅 프로토콜

**거리 벡터 라우팅 프로토콜(Distance Vector Gateway Protocol)**은 라우터가 직접 연결된 이웃 라우터와 라우팅 정보를 주기적으로 교환하는 방식이다. 벨만-포드 알고리즘을 사용하여 홉(라우터)의 개수가 적은 경로를 택한다. 홉 개수에 제한이 있어 소규모 네트워크 환경에 적합하다. 간단하고 가장 많이 사용되는 알고리즘이다. 새로 갱신된 정보는 라우터를 순차적으로 타고가야하므로 컨버전스 타임이 느리다. 전체 경로가 담긴 라우팅 테이블을 주기적으로 브로드캐스팅하여 네트워크에 부하를 준다. 또한 네트워크 환경은 고려하지 않고 홉의 개수만 고려하여 오히려 비효율적일 수 있다.

대표적인 프로토콜은 **RIP(Routing Information Protocol)**이다. RIP 패킷은 UDP 프로토콜을 사용한다. 

### 링크 상태 라우팅 프로토콜

**링크 상태 라우팅 프로토콜(Link State Gateway Protocol)**은 라우터가 개별적으로 이웃 라우터까지의 거리 정보를 구하고 네트워크에 연결된 모든 라우터에게 통보한다. 변화가 있을 때에만 플러딩(Flooding; 출력 가능한 모든 경로로 패킷 전송) 기법으로 정보 전달이 이루어진다. 다익스트라 알고리즘을 사용하여 Link Cost(홉, 지연시간, 링크 대역폭 등)이 가장 적은 최단 경로를 계산한다. 플러딩을 사용하여 컨버전스 타임이 빠르다. 라우팅 알고리즘이 복잡하여 프로세서에게 부담을 줄 수 있다.

대표적인 프로토콜은 **OSPF(Open Shortest Path First)**이다.

### 경로 벡터 라우팅 프로토콜

**경로 벡터 라우팅 프로토콜(Path Vector Routing Protocol)**은 라우터에서 최종 목적지 네트워크까지의 경로를 제공하는 프로토콜이다.

대표적인 프로토콜은 **BGP(Border Gateway protocol)**이다. BGP는 종류가 다른 AS에서 동작하는 라우터가 라우팅 정보를 교환할 수 있도록 한다. TCP 프로토콜을 사용하여 메시지를 교환한다.



## IP 주소

IP 주소는 네트워크의 호스트를 구분하는 주소이다. 호스트가 인터넷에 접속하려면 반드시 IP 주소를 할당받아야한다. 

### IPv4 주소 체계와 네트워크 클래스

IPv4에서 IP 주소는 32비트의 이진수로 8비트씩 끊어 `.`로 구분한다.

IP 주소는 대역에 따라 다섯 개의 네트워크 클래스 A, B, C, D, E로 나뉜다. A, B, C는 유니캐스팅, D는 멀티캐스팅(일대다전송)에 사용한다. E는 새로운 응용 환경을 위해 잠정적으로 예약되었다.

클래스 A, B, C는 주소를 `network`와 `host` 필드로 구분한다.

- `network`: 네트워크를 식별하는 네트워크 주소이다. NIC(Network Information Center)에서 담당한다.
- `host`: 호스트를 식별하는 호스트 주소이다. 네트워크 주소가 결정되면 네트워크 관리자가 할당한다.

클래스마다 각 필드의 비트 수가 다르다.

| 클래스 | 네트워크 ID 비트 수 | 호스트 ID 비트 수 | 네트워크 규모 | 네트워크 /호스트 주소 |
| ------ | ------------------- | ----------------- | ------------- | --------------------- |
| A      | 8비트               | 24비트            | 대규모        | www / www.yyy.zzz     |
| B      | 16비트              | 16비트            | 중간          | www.xxx / yyy.zzz     |
| C      | 24비트              | 8비트             | 소규모        | www.xxx.yyy / zzz     |

호스트 주소를 표현하는 모든 비트의 값이 0이면 해당 서브넷 자체를 지칭한다. 1이면 서브넷의 모든 호스트를 지칭한다.

### 서브넷

**서브넷(subnet)**은 하나의 네트워크에서 분할된 네트워크이며 서브넷 마스크를 사용하여 네트워크를 분할하는 것을 서브네팅(subnetting)이라고 한다. IPv4 주소 부족 문제를 해결하기 위해 등장하였다.

### 공인 IP와 사설 IP

**공인 IP(Public IP)**는 네트워크 외부와 통신할 때 사용하는 주소이다. ISP(Internet Service Provider)가 제공하며 전세계에서만 유일하다. **사설 IP(Private IP)**는 네트워크 내부에서만 사용하는 주소이다. 라우터가 제공하며 하나의 네트워크에서만 유일하다. 네트워크에 속한 여러 호스트는 하나의 public ip를 공유해 인터넷에 접속할 수 있게 된다.

### 고정 IP와 유동 IP

고정 IP(Static IP)는 호스트에 고정적으로 부여되는 주소로 반납하기 전까지 독점한다. 보안성이 우수하다. 유동 IP(Dynamic IP)는 호스트에게 임시로 부여되는 주소로, 대부분 호스트는 네트워크에 접속할 때마다 새로운 IP를 발급받는다.

### NAT

**NAT(Network Address Trasmission)**은 라우터 또는 방화벽에서 IP 패킷의 포트 번호와 IP 주소를 다시 기록하여 네트워크 트래픽을 주고받는 기술이다. 패킷이 네트워크 외부로 나갈 때 사설 IP를 공인 IP로 변환하고, 패킷이 네트워크 내부로 들어올 때 공인 IP를 사설 IP로 변환한다. NAT의 주소 풀에 주소가 부족하면 패킷이 삭제되고 ICMP 메시지가 송신 호스트에게 발송된다.



## 혼잡 제어

### 혼잡의 원인

혼잡은 기본적으로 네트워크가 처리할 수 있는 패킷보다 많은 패킷이 입력되어 발생한다. 패킷이 분실되는 경우, 혹은 패킷 순서가 바뀌어 패킷을 버리는 경우 송신 호스트는 타임아웃 동작을 통해 패킷을 재전송한다. 결국 네트워크 혼잡도가 계속 증가하는 악순환에 빠지게 된다. 혼잡이 포착되면 타임아웃 시간을 늘려 재전송이 빈번하게 일어나지 않도록 하거나 트래픽이 적은 경로로 패킷을 전송하여 혼잡도를 줄일 수 있다. 한편 패킷이 네트워크에서 생존할 수 있는 시간을 너무 크게 주면 불필요한 부하를 줄 수 있고, 너무 작게 주면 패킷이 강네트워크 질문 혼잡 제어제로 제거되어 재전송이 발생할 수 있다. 따라서 패킷의 생존 시간을 적절히 설정해주어야 한다.

### 혼잡 제거

라우터는 출력 선로의 사용 정도가 한계치를 초과하면 주의 표시를 한다. 패킷이 주의 표시된 출력 선로로 라우팅되는 경우 송신 호스트에게 `ECN` 패킷을 전송한다. `ECN` 패킷을 인지한 송신 호스트는 `ECN` 패킷이 발생하지 않을 때까지 전송 패킷의 양을 줄인다.



## IP

**IP(Internet Protocol)**는 인터넷 환경에서 사용되는 네트워크 계층의 데이터 전송 프로토콜이다. 비연결 서비스를 제공한다. IP에서 사용하는 데이터의 단위를 **패킷(package)**이라고 한다. 패킷은 IP 헤더와 데이터 필드로 나뉜다.

### IP Header

#### DS/ECN

- DS(Differentiated Services): 차등 서비스의 기준이 되는 레이블 값으로 2^6개의 트래픽 클래스를 정의할 수 있다.
- ECN(Explicit Congestion Notification): 송신 호스트가 라우터에게 IP 패킷에 캡슐화된 TCP 프로토콜이 ECN 기능을 지원한다고 알려주기 위해 사용한다.
  - `00`: IP 패킷이 ECN 기능을 사용하지 않음
  - `01(ECT 1)`, `00(ECT 0)`: TCP 프로토콜도 ECN 기능을 지원한다.
  - `11(CE: Congestion Experienced)`: 라우터가 송신 호스트에 혼잡을 통지하기 위해 사용한다.

#### 패킷 분할

IP는 상위 계층에서 내려온 데이터가 네트워크에서 처리할 수 있는 크기보다 크면 분할(fragmentation)하여 전송한다.

- Identification: 송신 호스트는 분할된 패킷들에 동일한 고유 번호를 부여한다. 수신 호스트는 이 필드로 동일한 번호를 가진 패킷들을 병합(reassembly)할 수 있다. 분할된 패킷이 아니라면 필드의 값이 1씩 증가한다.
- DF(Don't Fragment): 수신 호스트가 패킷을 병합하는 기능이 없을 때 설정하여 패킷이 분할되지 않도록 한다. 중간 경유 네트워크는 IP 패킷이 자신이 처리 가능한 것보다 크고 이 필드가 설정되어있으면 패킷을 버린다.
- MF(More Fragment): 분할 패킷은 연속하여 전송되므로, `1`로 지정하면 뒤에 오는 패킷이 분할 패킷임을 알린다. 마지막 분할 패킷은 `0`으로 지정한다.
- Fragment Offset: 분할 전 데이터에서 위치하는 상대 주소 값을 저장한다.

#### 주소

- Source Address: 송신 호스트의 IP 주소
- Destination Address: 수신 호스트의 IP 주소

#### 기타

- Version Number: IP 프로토콜의 버전 번호
- Header Length: IP 프로토콜 헤더의 길이를 32비트 워드 단위로 표시한다.
- Packet Length: IP 헤더를 포함한 패킷의 길이를 표시한다.
- TTL(Time to Live): 패킷이 목적지에 도착하지 못해 네트워크에서 떠돌지 않도록 생존 시간을 지정한다. `0`으로 감소하면 패킷은 버려지고 송신 호스트에 ICMP 오류 메시지가 전달된다.
- Transport:  IP에 데이터 전송을 요구한 전송 계층의 프로토콜을 가리킨다. TCP는 6, UDP는 17, CMP는 1이다.
- Header Checksum: 헤더의 오류를 검출한다. 오류가 검출되면 해당 패킷을 버린다.
- Options: 기타 용도로 사용할 정보를 넣는다.
- Padding: 헤더의 크기를 4바이트 단위로 맞추기 위해 사용한다.



## IPv6

현재 사용되고 있는 IPv4는 32비트의 주소 공간을 지원한다. 인터넷의 확장에 따라 여러 문제점이 제기되었다. 차세대 IP인 IPv6은 IPv4와 비교하여 다음 기능을 제공한다. 첫번째, 주소 공간이 128비트로 확장되었다. 두번째, 헤더 구조가 단순화되었다. 세번째, 흐름 제어 기능을 지원한다.

### Ipv6 주소 체계

IPv6 주소는 128비트의 이진수로 16비트씩 끊어 `:`로 구분한다. 

### IPv6 Header

#### DS/ECN 필드

IPv4와 동일

#### Flow Label 필드

IPv4 패킷은 라우터가 동일한 기준을 적용하여 중개하한다. IPv6은 특정 송수신 호스트 사이에서 전송되는 데이터를 하나의 flow으로 정의해 중간 라우터가 IPv6 패킷을 특별한 기준으로 처리할 수 있도록 지원한다.

#### 주소

- Source Address: 송신 호스트의 IP 주소
- Destination Address: 수신 호스트의 IP 주소

#### 기타 필드

- Version Numbe: 6으로 지정된다.
- Payload Length: 헤더를 제외한 패킷의 크기. 바이트 단위.
- Next Header: 기본 헤더 다음에 이어지는 헤더의 유형을 수신 호스트에 알려준다. IPv6의 확장 헤더, TCP/UDP의 헤더일 수 있다.
- Hop Limit: IPv4의 Time To Live와 동일하다. 이론상 시간 개념이 포함되었던 것을 단순화하여 중개되는 횟수로만 처리한다.

#### 확장 헤더

IPv6 헤더 뒤에 하나 이상의 확장 헤더를 추가할 수 있다.

- Hop-by-Hop Options Header
- Routing Header: IPv4의 소스 라우팅과 유사한 기능을 제공한다. 주소 목록에 적힌 순서대로 호스트를 거치도록 한다.
- Fragment Header: IPv4 헤더의 패킷 분할과 관련된 정보(Fragment Offset, Identification, MF 필드)를 포함한다.
- Destination Options Header: 수신 호스트가 확인할 수 있는 옵션 정보 제공
- Authenication Header: 패킷 인증과 관련된 기능 제공
- Encapsulating Security Payload Header: 페이로드를 암호화한다. 목적지 호스트에서 암호화 데이터를 해독할 수 있는 정보를 제공한다.



## DHCP

**DHCP(Dynamic Host COnfiguration Protocol)**는 호스트에 IP 주소를 동적으로 할당하는 기능을 제공하는 프로토콜이다. DHCP는 클라이언트/서버 모델을 따른다. DHCP 서버는 할당 가능한 IP 주소의 풀을 관리한다. 클라이언트가 서버에게 요청 메시지를 전송하면 서버는 IP 주소를 할당하여 응답한다. 클라이언트는 사용이 끝나면 IP 주소를 반환한다. 클라이언트의 포트 번호는 68, DHCP 서버의 포트 번호는 67이다.



### DHCP 프로토콜 동작 과정

DHCP 메시지는 UDP 데이터그램에 캡슐화되어 전송된다. DHCP 메시지의 `Options` 필드로 메시지의 종류를 구분한다.

1. `DHCP_DISCOVER`: 클라이언트가 DHCP 서버를 찾기 위해 DHCP 메시지를 브로드캐스팅한다.
2. `DHCP_OFFER`: DHCP 서버가 `DHCP_DISCOVER` 메시지에 브로드캐스팅으로 응답한다. `Your IP Address` 필드에 권고하는 IP 주소를 지정한다.
3. `DHCP_REQUEST`: 클라이언트는 응답받은 여러 `DHCP_OFFER` 중 적당한 IP 주소를 선택하여 브로드캐스팅한다.
4. `DHCP_ACK`/`DHCP_NACK`: `DHCP_REQUEST` 메시지를 받은 DHCP 서버는 최종적으로 IP 주소가 사용 가능한지 확인하고 `DHCP_ACK` 메시지를 보낸다. 먼저 선점되었다면 `DHCP_NACK` 메시지를 보낸다. 이 경우 클라이언트는 다시 `DHCP_DISCOVER`를 시도해야한다.



## ARP

**ARP(Address Resolution Protocol)**은 IP 주소를 MAC 주소로 변환하는 기능을 제공하는 프로토콜이다. TCP/IP에서 송신 호스트가 사용자가 사용자 프로그램에 입력한 수신 호스트의 IP 주소에 대응하는 MAC 주소를 얻기 위해 사용한다. 호스트는 다른 호스트의 IP 주소와 MAC 주소의 대응 관계를 저장한 ARP 캐시 테이블을 유지한다.

### ARP 프로토콜 동작 과정

1. `ARP request`: 송신 호스트가 네트워크의 모든 호스트들에게 패킷을 브로드캐스팅한다.
2. `ARP reply`: 자신의 IP 주소라면 해당 호스트는 MAC 주소를 송신 호스트에게 회신한다.



## RARP

**RARP(Reverse Address Resolution Protocol)**은 MAC 주소를 IP 주소로 변환하는 기능을 제공하는 프로토콜이다. IP 주소는 파일에 보관되므로 파일 시스템이 존재하지 않는 호스트가 자신의 IP 주소를 얻기 위하여 사용한다.

### RARP 프로토콜 동작 과정

1. 송신 호스트가 MAC 주소를 매개변수로 패킷을 브로드캐스팅한다.
2. RARP 서버가 IP 주소를 송신 호스트에게 회신한다.

 ICMP는 전송 오류가 발생하면 복구 작업을 위해 오류 메시지를 전송하는 프로토콜이다.



## ICMP

**ICMP(Internet Control Message Protocol)**은 IP 패킷 전송에서 발생한 오류를 송신 호스트에게 전달하는 기능을 제공하는 프로토콜이다. TCP/IP 기반 통신망에서 패킷 전송 오류가 발생하면 라우터에 의해 ICMP 메시지가 발생한다.



## 참고

[ARP 쉽게 이해하기](https://aws-hyoh.tistory.com/entry/ARP-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0)
[Network\] ARP(주소 결정 프로토콜)에 대하여](https://coding-factory.tistory.com/720)

[geeksforgeeks - Network Address Translation(NAT)](https://www.geeksforgeeks.org/network-address-translation-nat/?ref=lbp)

[NordVPN - 공인 IP, 사설 IP… 다양한 IP 유형의 차이는?](https://nordvpn.com/blog/public-ip-and-private-ip/)



## 스터디

IP 주소가 무엇인가요?

네트워크에서 호스트를 식별하는데 사용하는 논리적 주소이다.

1. IPv4에서 주소 고갈 문제는 어떻게 해결하고 있나요?

   IP 주소를 public IP와 private IP로 나누어 해결하고 있다.

   1. public IP와 private IP의 차이는 무엇인가요?

      public IP는 네트워크 외부와 통신하기 위해 사용하지만 private IP는 네트워크 내부에서 통신하기 위해 사용한다. public IP는 ISP가 할당하지만 private IP는 네트워크 관리자나 라우터가 할당한다. public IP로는 인터넷에 접속할 수 있지만 private IP로는 그럴 수 없다. public IP는 고유하나 private IP는 다른 네트워크의 IP 주소와 중복될 수 있다.

      1. private IP를 사용해서 얻을 수 있는 이점이 있나요?

         public IP는 외부에 공개되어있으므로 추적당할 위험이 있다. private IP를 사용하면 네트워크 외부로부터 오는 보안 공격은 public IP 하나만 주의하면 된다.



### MAC 주소가 있는데 왜 IP 주소를 사용할까?

TODO
