# Transport Layer

**전송 계층(transport layer)**는 송수신 호스트에서 실행되는 프로세스 간의 종단 연결을 지원한다. 송신 호스트의 전송 계층은 상위 계층에서 내려온 데이터를 분할(segementation)하여 전송하며 수신 호스트의 전송 계층은 하위 계층에서 올라온 데이터를 병합(reassembly)한다.



## 전송 계층의 프로토콜과 연결 설정

송신자와 수신자는 패킷을 전달하기 전 서로 `연결을 설정`하거나 그러지 않을 수 있다. **비연결 서비스**의 경우 패킷이 순서대로 전달되었는지, 송신자가 보낸 패킷이 수신자에게 제대로 도착했는지 등을 확인하지 않으므로 **연결 서비스**보다 데이터의 신뢰성이 떨어진다.

전송 계층에서 사용하는 프로토콜에는 TCP와 UDP가 있다. 이때 TCP는 연결형 서비스를 지원하며 UDP는 비연결형 서비스를 지원한다. 전송 계층 프로토콜은 커널 내부에 구현되어, 상위 계층은 시스템 콜을 호출하여 프로토콜이 제공하는 서비스를 사용할 수 있다.



## TCP

**TCP(Transmission Control Protocol)**는 연결형 서비스로서 오류 제어, 흐름 제어, 혼잡 제어를 통하여 신뢰성 있는 데이터 전송을 보장한다. TCP에서 사용하는 데이터의 단위를 **세그먼트(segment)**라고 한다. 세그먼트는 TCP 헤더와 데이터 필드로 나뉜다.

### TCP Header

![tcp segment](https://user-images.githubusercontent.com/57662010/195682499-2f7fffd4-b7ea-479b-8bb1-9b70d3a214de.png)

TCP 헤더에서 각각의 필드는 다음을 나타낸다.

- **송신 포트(source port), 수신 포트(destination port)**: 프로세스에게 할당되는 네트워크 자원을 포트(port)라고 하며, 포트를 구분하는 주소를 포트 번호라고 한다. 송신 포트와 수신 포트는 각각 송신 프로세스와 수신 프로세스에게 할당된 네트워크 포트를 구분하는 주소이다. TCP와 UDP는 별도의 주소 공간을 가지므로 같은 포트 번호를 독립적으로 사용할 수 있다.
- **순서 번호(Sequence Number)**: 송신 프로세스가 지정한 순서 번호로, 전송되는 바이트의 수를 기준으로 증가한다.
- **응답 번호(Acknowledgement Number)**: <u>다음에 수신하기를 기대하는 데이터의 순서 번호</u>를 표시한다. 즉, `응답 번호 - 1`까지의 모든 데이터를 제대로 수신하였음을 송신자에게 응답한다. `ACK` 플래그가 1이면 유효하다. 연결 설정이나 연결 해제를 할 때에는 수신한 데이터가 없지만 순서 번호가 1씩 증가한다.
- **데이터 오프셋(Data Offset)**: TCP 헤더의 크기를 나타낸다. 32비트 워드 단위이다.
- **예약(Reserved)**
- **윈도우 크기(Window size)**: 슬라이딩 윈도우 프로토콜에서 수신 윈도우의 버퍼 크기를 지정하기 위해 사용한다. 수신 프로세스가 수신할 수 있는 바이트의 수를 나타낸다.
- **체크섬(Checksum)**: TCP 세그먼트가 변형되었는지 오류를 검출하는데 사용한다. IP 프로토콜에서 사용하는 오류 검출 알고리즘을 사용한다.
- **긴급 포인터(Urgent Pointer)**: 수신 프로세스의 응용 계층에 긴급 데이터가 도착했음을 알리기 위해 사용한다. `URG` 플래그가 1이면 유효하다.
- 플래그들
  - `ECE`, `CWR`: 혼잡 제어에 사용한다.
  - `URG`: 긴급 포인터 필드가 유효한지 나타낸다.
  - `ACK`: 응답 번호 필드가 유효한지 나타낸다. 연결 설정 과정에서 전송되는 첫번째 세그먼트를 제외한 모든 세그먼트의 `ACK` 비트는 1이다.
  - `PSH`: 현재 세그먼트의 데이터를 상위 계층에 즉시 전달하도록 지시할 때 사용한다.
  - `RST`: 세그먼트를 재전송해야한다는 것을 나타낸다. 연결을 재설정하거나, 유효하지 않은 세그먼트에 대해 응답할 때 사용한다. 
  - `SYN`: 연결 설정을 요구하는 플래그로 연결을 설정할 때 사용한다.
  - `FIN`: 연결 해제를 요구하는 플래그로 연결을 해제할 때 사용한다.
- 옵션(Options)/패딩(Padding): 최대 40바이트로 다양한 종류의 부가 정보를 전달하는데 사용한다. 패딩 필드는 헤더의 크기를 4바이트 단위로 맞추기 위해 사용한다.



## TCP 프로토콜에서 데이터의 전송

### TCP 연결 설정(3-way handshaking)

![image](https://user-images.githubusercontent.com/57662010/195692118-fc854fa0-6317-4eb9-bf1f-aab67510988d.png)

프로세스 A가 프로세스 B에게 연결 설정을 요구한다고 하자.

1. 프로세스 A는 `SYN` 플래그를 지정하여 연결 설정을 요구한다. 임의의 순서 번호 `seq=10`을 보냈다.
2. 프로세스 B는 `SYN` 플래그와 `ACK` 플래그를 지정하여 연결 설정에 긍정한다. 임의의 순서 번호 `seq=50`와 응답 번호 `ack=11`을 보낸다.
3. 프로세스 A는 `ACK` 플래그를 지정한다. `seq=11`, `ack=51`을 보낸다.



### TCP 연결 해제(4-way handshaking)

프로세스 A가 프로세스 B에게 연결 해제를 요구한다고 하자.

1. 프로세스 A는 `FIN` 플래그를 지정하여 연결 해제를 요구한다. 이때 순서 번호가 `seq=16`, 응답 번호가 `ack=61`이라고 하자.
2. 프로세스 B는 `ACK` 플래그를 지정하여 연결 해제를 요구하는 세그먼트를 성공적으로 수신받았음을 알린다. 순서 번호는 `seq=61`, 응답 번호는 `ack=17`이다.
3. 프로세스 B는 `FIN` 플래그를 지정하여 연결 해제에 긍정한다. 순서 번호는 `seq=61`, 응답 번호는 `ack=17`이다. 프로세스 B가 `FIN` 플래그를 지정하여 세그먼트를 보내기 전까지 프로세스 A와 B는 통신할 수 있다.



### 오류 제어

데이터 전송 오류에는 데이터 변형과 데이터 분실이 있다. 전송 오류가 발생하면 수신 프로세스는 응답을 하지 않는다. 송신 프로세스는 타임아웃(timeout) 기능을 사용하여 응답이 오지 않으면 재전송을 실행한다.



### 흐름 제어

수신 프로세스의 데이터 수신 속도가 송신 프로세스의 데이터 송신 속도보다 느린 경우 데이터 분실이 일어날 수 있다. 데이터 분실이 일어나면 수신 프로세스는 응답을 하지 않고, 송신 프로세스가 타임아웃 기능을 수행하면 네트워크 전송 효율이 떨어진다. 이때 수신 프로세스는 헤더의 Window 필드에 적절한 값을 지정한다. 송신 프로세스는 해당 값까지는 연속으로 데이터를 전송하고 그 이상의 데이터는 수신 프로세스로부터 응답이 도착하면 전송한다.



### 혼잡 제어

TCP 헤더의 `ECE`, `CWR` 플래그와 IP 헤더의 `ECN` 필드로 ECN(Explicit Congestion Notification)을 지원한다.

- **혼잡 제어**(; EWR, ECE 플래그를 사용): 네트워크 트래픽의 증가로 혼잡 발생시 이를 송신 프로세스에게 알려 트래픽을 완화하도록 한다.



## UDP

**UDP(User Datagram Protocol)**는 비연결형 서비스를 제공하므로, 연결형 서비스를 제공하는 TCP보다 신뢰성이 떨어진다. UDP에서 사용하는 데이터의 단위를 **데이터그램(datagram)**라고 한다. 데이터그램은 UDP 헤더와 데이터 필드로 나뉜다.

### UDP Header

![udp datagram](https://user-images.githubusercontent.com/57662010/195682494-7fec1634-f11e-4f0a-8f24-f590fafb491e.png)

UDP 헤더에서 각각의 필드는 다음을 나타낸다.

- **송신 포트(source port), 수신 포트(destination port)**: 송신 프로세스와 수신 프로세스를 구분하는 포트 번호이다.
- **길이(Length)**: UDP 데이터그램의 크기를 나타낸다. 바이트 단위이며 헤더의 길이는 8바이트이다.
- **체크섬(Checksum)**: 프로토콜 헤더와 데이터에 대한 체크섬 값이다. 수신 프로세스는 체크섬 오류를 발견하면 데이터그램을 버린다.

### 데이터그램의 전송

UDP는 Best effort 전달 방식을 지원한다. 이는 목적지까지 도착할 수 있도록 최선을 다하나 목적지에 도착하는 것은 보장하지 않는 방식을 의미한다. 또한 흐름 제어 기능 등을 제공하지 않아 데이터그램 분실이나 도착 순서가 변경되는 오류가 발생할 수 있다. 이러한 오류를 해결하려면 응용 계층의 프로세스가 내부적으로 기능을 구현해야한다.

### TCP와의 비교

연결형 서비스를 제공하기 위한 정보를 요구하지 않아 헤더의 구조가 TCP보다 간단하여, 데이터의 처리가 빠르다. 따라서 패킷 손실에는 둔감하고 데이터 전송 시간이나 실시간성에 예민한 멀티미디어 응용 환경(스트리밍)에 사용된다.



## 참고

- [The OSI Model](https://www.coengoedegebure.com/osi-model/)
- 쉽게 배우는 데이터 통신과 컴퓨터 네트워크